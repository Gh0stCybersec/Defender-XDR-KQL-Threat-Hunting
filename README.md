# Defender-XDR-KQL-Threat-Hunting
A collection of custom KQL threat hunting queries that can be used to create detection rules with in Microsoft Defender XDR. 

## Defender KQL Queries

Kusto Query Language or  "KQL" is a powerful language used to query and analyze data within Microsoft's Defender for XDR (Extended Detection and Response) system. KQL is utilized in Microsoft 365 Defender (formerly known as Microsoft Defender for XDR) to search across security logs, detect threats, and investigate security incidents.




Example of query editor for Defender XDR.
![image](https://github.com/user-attachments/assets/e233a335-0f42-4009-bf72-615bfa6b4612)


## Practical Tips
Use the "where" clause to filter data based on specific conditions.
"project" clause helps you select specific columns to display in the result.
"summarize" clause is useful for aggregation (e.g., counting, averaging).
Use "let" to define reusable expressions or subqueries within the main query.


## Common Tables used

SecurityAlert: Contains data on security alerts generated by various Defender components.

DeviceEvents: Logs events occurring on devices, such as process executions and network activities.

DeviceProcessEvents: Details processes executed on devices, including associated metadata.

SecurityIncident: Provides information about security incidents within the Defender environment.

## Examples 

### Search for alerts and incidents:

This query fetches high-severity alerts, displaying the timestamp, alert name, severity, and description, and sorts them by the most recent.

```
SecurityAlert
| where AlertSeverity == "High"
| project Timestamp, AlertName, AlertSeverity, Description
| sort by Timestamp desc
```

### TimeGenerated to filter by time range 
This query retrieves incidents that have occurred within the last 7 days. This can be changed up to a maximum of 30 days.
```
SecurityIncident
| where TimeGenerated > ago(7d)
| project IncidentId, Title, Severity, Status
```


### Querying Multiple Tables

This query looks as two seperate tables "DeviceEvents" and "SecurityAlerts". It identifies devices that have connected to a specific IP address and then looks for any security alerts related to those devices.
```
let suspiciousDevices = DeviceEvents
    | where ActionType == "NetworkConnection"
    | where RemoteIP == "192.168.1.10"
    | project DeviceId;

SecurityAlert
| where DeviceId in (suspiciousDevices)
| project Timestamp, AlertName, Description, DeviceId
```

